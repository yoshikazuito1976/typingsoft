# タイピングソフト改修 作業ログ（日本語辞書化対応）

## 作業日
2026年1月19日（途中まで）

---

## 目的（今日やろうとしていたこと）

### 問題データ（quest.js）を辞書形式に変更

表示・判定・入力を分離する：
- **表示**：漢字 / ひらがな / カタカナ OK
- **判定**：ひらがな
- **入力**：ローマ字

将来的に多言語（日本語 / 英語）を切り替え可能にする

---

## 変更したデータ構造（quest.js）

### 旧（配列ベース）
```javascript
["あいす", "あーむばんど", ...]
```

### 新（辞書形式）
```javascript
{
  category: "日本語",
  items: [
    {
      display: "アームバンド",
      kana: "あーむばんど",
      romaji: ["a-mubando"]
    },
    {
      display: "おはよう",
      kana: "おはよう",
      romaji: ["ohayou", "ohayo"]
    }
  ]
}
```

---

## 設計方針（確定）

### 表示・判定・入力の責務分離

| 役割 | 使うデータ |
|------|------------|
| 問題表示 | `display` |
| 入力判定 | `kana` |
| ユーザー入力 | ローマ字（key入力） |

**👉 `display` は表示専用、ロジックでは使わない**

---

## program.js 側で行った主な変更

### NextWordView() を辞書対応に変更
```javascript
const q = tmpList[r];
tmpWord = q.kana; // 判定用
document.querySelector(".msgStr").textContent = q.display; // 表示用
```

- `tmpWord` = 判定対象（ひらがな）
- `.msgStr` = 表示対象（display）

---

## 発生している問題（未解決）

### 1. 表示が romaji / kana に上書きされる

- **本来**：`.msgStr` に `display` を出したい
- **実際**：AISU, DOG など ローマ字表示になる

**原因：**
- `program.js` 内の他の処理で `.msgStr.textContent` を上書きしている
- 特に以下が疑わしい：
  - 入力判定中
  - レッスン終了処理
  - 旧仕様の名残コード

### 2. q is not defined エラーが出た
```
Uncaught ReferenceError: q is not defined
```

**原因：**
- `q` は `NextWordView()` 内のローカル変数
- `lessonStart()` や他の関数で `q.display` を使っていた

**対処：**
- `lessonStart()` では表示処理を一切しない
- 表示は `NextWordView()` のみに集約する方針でOK

---

## 今日の結論（重要）

### ✔ 設計は正しい(はず？）
- 辞書化の方向性は問題なし
- 表示 / 判定 分離も正しい

### ❌ 問題は「コードの残骸」
- 旧仕様の `.msgStr.textContent = tmpWord` が残っている
- それが `display` を上書きしている
まだ特定できていない。
---

## 次回やること（TODO）

### ① program.js で .msgStr を触っている箇所を全検索
```javascript
document.querySelector(".msgStr")
```
**👉 NextWordView() 以外は原則削除**

### ② 表示ルールを強制
- `.msgStr` → `display` 専用
- `.inputBefore` → ローマ字ガイド専用
- `.inputAfter` / `.inputBuf` → 入力状態表示

### ③ 一時デバッグ用チェック（有効）
```javascript
console.log("DISPLAY:", q.display);
console.log("KANA:", tmpWord);
```

---

## 状態まとめ

- ✅ スタートできる
- ✅ 入力イベント動いている
- ✅ データ構造は正しい（はず）
- ❗ バグは設計ミスではなく整理不足なのでちゃんと確認する
- ❗ 今の状態でHTMLをいじる必要はなし。program.js 側の整理を優先
